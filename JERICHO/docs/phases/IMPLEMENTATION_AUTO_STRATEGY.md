# Auto Strategy + Auto Block Seeding - Implementation Summary

## Overview

Implemented a fully automatic deliverables and block generation system. After goal admission, the system now:
1. **Auto-detects goal type** (music release vs generic)
2. **Auto-seeds 3+ deliverables** based on goal and time window
3. **Auto-generates plan blocks** immediately after admission
4. **Enforces single outcome per cycle** (rejects compound goals)

**Result**: `suggestedBlocks.length > 0` for any reasonable goal with future deadline and non-zero capacity.

---

## Changes Implemented

### 1. **New Module: `src/domain/autoStrategy.ts`**

**Exports:**
- `buildAutoDeliverablesFromGoalContract(contract, nowDayKey, timeZone)` ‚Üí Returns 3+ deliverables
- `detectCompoundGoal(contract)` ‚Üí Identifies multi-outcome goals for rejection

**Logic:**
- **Music Release Detection**: Checks for keywords like "release", "album", "spotify", "tracks", "promo"
  - If detected: Generates music-specific phases (finalize masters ‚Üí artwork ‚Üí promo ‚Üí daily execution)
  - If generic: 3-phase generic template (planning ‚Üí execution ‚Üí verification)
- **Block Scaling**: Calculates required blocks per deliverable based on days remaining
  - Short window (3-7 days): Fewer blocks per deliverable
  - Long window (30+ days): More granular breakdown across phases
- **Compound Goal Detection**: Pattern matching for conjunction keywords and semicolon-separated outcomes
  - Rejects goals containing "and... also/simultaneously/in parallel"
  - Rejects goals with multiple semicolon-separated objectives

---

### 2. **Modified: `src/state/identityStore.js`**

#### Added Imports:
```javascript
import { buildAutoDeliverablesFromGoalContract, detectCompoundGoal } from '../domain/autoStrategy.ts';
```

#### Updated `attemptGoalAdmissionPure(state, contract)`:

**New Policy Enforcement: Compound Goal Detection**
- Before validation: Check if goal has multiple outcomes
- If compound: Reject immediately with code `MULTIPLE_OUTCOMES_DETECTED`
- User guidance: "Goal contains multiple outcomes; please choose one primary objective for this cycle"

**New Feature: Auto-Seed Deliverables on Admission**
- After cycle creation: Call `buildAutoDeliverablesFromGoalContract()`
- Only seeds when deliverables empty (doesn't overwrite user edits)
- Stores metadata: `autoGenerated: true`, `autoStrategy: {detectedType, rationale}`

**New Feature: Auto-Run Plan Generation**
- After cycle + deliverables setup: Call `computeDerivedState(..., { type: 'GENERATE_COLD_PLAN' })`
- Result: `suggestedBlocks` populated immediately upon admission

---

### 3. **Modified: `src/state/identityCompute.js`**

#### Added Import:
```javascript
import { buildAutoDeliverablesFromGoalContract } from '../domain/autoStrategy.ts';
```

#### Updated `generateColdPlanForCycle(state, {...})`:

**Changed Strategy (STEP 3):**
- **Old**: If deliverables empty ‚Üí Set error + return
- **New**: If deliverables empty ‚Üí Auto-seed them, update strategy, continue planning

**Logic:**
1. If `deliverables.length === 0 || totalRequired === 0`:
   - Call `buildAutoDeliverablesFromGoalContract()` 
   - Update `cycle.strategy.deliverables`
   - Update `deliverablesByCycleId[cycleId]` workspace
   - Recompute assumptions hash
2. Continue with plan generation as normal
3. Only fail after auto-seed if deadline still invalid

**Result**: Users never hit "NO_DELIVERABLES" error unless deadline is truly invalid.

---

### 4. **Modified: `src/components/zion/StructurePageConsolidated.jsx`**

#### UI Enhancement: Deliverables Panel

**Before:**
- Collapsed section with generic text

**After:**
- Collapsed summary showing:
  - "N blocks proposed" (if auto-generated)
  - "Auto-generated" label (green badge if auto-seeded)
- Expanded detail view:
  - Green banner explaining: "Auto-generated deliverables ¬∑ Edit optional ¬∑ derivable from goal commitment"
  - List of deliverables with titles and required blocks
  - Visual distinction for auto-generated vs manual

**Code:**
```jsx
<details className="...">
  <summary className="... justify-between ...">
    <div>Deliverables</div>
    <div>
      {suggestedBlocks.length} blocks proposed
      {autoGenerated && <span className="success">Auto-generated</span>}
    </div>
  </summary>
  <div>
    {autoGenerated && <div className="banner">Auto-generated deliverables...</div>}
    <div>List of deliverables</div>
  </div>
</details>
```

---

## Architecture: How It Works

### Admission Flow (New)

```
User submits contract
    ‚Üì
detectCompoundGoal() ‚Üê POLICY ENFORCEMENT
    ‚îú‚îÄ Is compound? ‚Üí REJECT (MULTIPLE_OUTCOMES_DETECTED)
    ‚îî‚îÄ Single outcome? ‚Üì
validateGoalAdmission() ‚Üê HARD GATES
    ‚îú‚îÄ Failed validation? ‚Üí REJECT
    ‚îî‚îÄ Passed? ‚Üì
CREATE CYCLE
    ‚Üì
AUTO-SEED DELIVERABLES
buildAutoDeliverablesFromGoalContract() ‚Üê NEW
    ‚îú‚îÄ Detect type (music/generic)
    ‚îú‚îÄ Scale blocks to time window
    ‚îú‚îÄ Store as autoGenerated=true
    ‚îî‚îÄ Update cycle.strategy ‚Üì
AUTO-GENERATE BLOCKS
computeDerivedState({type: 'GENERATE_COLD_PLAN'}) ‚Üê NEW
    ‚îî‚îÄ suggestedBlocks populated
            ‚Üì
       RETURN (ADMITTED, cycleId)
```

### Plan Generation Flow (Modified)

```
generateColdPlanForCycle() called
    ‚Üì
Check deliverables...
    ‚îú‚îÄ Empty? ‚Üí AUTO-SEED (NEW) ‚Üì
    ‚îú‚îÄ Auto-seed successful? ‚Üì
    ‚îî‚îÄ Continue with strategy
        ‚Üì
Check deadline validity
    ‚îú‚îÄ Invalid? ‚Üí ERROR + return
    ‚îî‚îÄ Valid? ‚Üì
Call generateColdPlan() (coldPlan.ts)
    ‚îú‚îÄ Allocates blocks to days
    ‚îú‚îÄ Respects constraints
    ‚îî‚îÄ Returns ColdPlanV1
        ‚Üì
Set lastPlanError if:
    ‚îú‚îÄ 0 blocks generated, OR
    ‚îî‚îÄ Infeasible (insufficient capacity)
        ‚Üì
    DONE
```

---

## Policy Enforcement

### Single Outcome Per Cycle

**Compound Goal Detection Rules:**
- Pattern 1: "X and [also/meanwhile/simultaneously] Y"
- Pattern 2: "X; [also/additionally] Y" (multiple semicolons)
- Pattern 3: List-like structures with 3+ semicolon-separated goals

**Action**: Hard reject with `MULTIPLE_OUTCOMES_DETECTED`

**User Experience:**
- Error message explains: "multiple outcomes detected"
- Suggests: "Choose one primary objective for this cycle; the other becomes an aspiration"

---

## Test Coverage

### New Tests (9 total)

#### `src/domain/autoStrategy.test.ts` (6 tests)
1. ‚úÖ Returns >=3 deliverables for valid goal
2. ‚úÖ Detects music release goals
3. ‚úÖ Generates music-specific deliverables
4. ‚úÖ Scales blocks based on time remaining
5. ‚úÖ Handles invalid deadline gracefully
6. ‚úÖ Detects compound goals with conjunction patterns

#### `src/domain/autoSeed.admission.test.ts` (3 tests)
1. ‚úÖ Detects and rejects compound goals
2. ‚úÖ Auto-seeds deliverables on admission
3. ‚úÖ Triggers plan generation after admission

### Existing Tests
- All 86 test files pass
- **278 total tests passing** (up from 269 before new tests)
- No regressions

---

## Deliverables Structure (Auto-Generated)

### Music Release Goal Example
```
Goal: "Release album on Spotify"
Deadline: 30 days from now

Auto-generated:
1. Finalize tracklist + masters (6 blocks)
2. Artwork + distribution setup (3 blocks)
3. Promo assets + rollout plan (4 blocks)
4. Daily promo execution (5 blocks)
Total: 18 blocks across 30 days
```

### Generic Goal Example
```
Goal: "Launch MVP web app"
Deadline: 25 days from now

Auto-generated:
1. Define scope + checklist (5 blocks)
2. Execute core work (6 blocks)
3. Verification + finalize (5 blocks)
Total: 16 blocks across 25 days
```

---

## Configuration: No LLM Required

All deliverable generation is **deterministic, pattern-based**:
- No external API calls
- No LLM dependencies
- Reproducible: Same goal + deadline = Same deliverables
- Editable: Users can modify generated deliverables

---

## User Experience Changes

### Before
1. Admit goal
2. See empty plan, empty deliverables
3. Manual entry required for blocks to appear
4. "How do I start planning?" ‚Üê Common question

### After
1. Admit goal
2. **Immediately** see:
   - 3+ auto-generated deliverables
   - Proposed blocks on calendar
   - Green "Auto-generated" label
3. Can edit if needed (optional)
4. Start working immediately

---

## Error Handling

### Plan Generation Errors (Enhanced)

If blocks can't be generated, error shows:
- **Code**: NO_BLOCKS_GENERATED, INFEASIBLE, DEADLINE_INVALID, etc.
- **Reasons**: List of specific failures
- **Details**: Constraint values, workable day count, dates
- **Expandable**: Click "Details" to see context

### Compound Goal Rejection

- **Code**: MULTIPLE_OUTCOMES_DETECTED
- **Reason**: Lists all detected outcomes
- **Action**: User must simplify to single objective

---

## Files Changed

| File | Change | Lines |
|------|--------|-------|
| `src/domain/autoStrategy.ts` | **NEW** | 180+ |
| `src/domain/autoStrategy.test.ts` | **NEW** | 200+ |
| `src/domain/autoSeed.admission.test.ts` | **NEW** | 240+ |
| `src/state/identityStore.js` | Import + admission flow | +50 |
| `src/state/identityCompute.js` | Plan preconditions | +40 |
| `src/components/zion/StructurePageConsolidated.jsx` | UI enhancement | +30 |

**Total New Code**: ~690 lines (tests + module + fixes)

---

## Non-Negotiable Outcomes ‚úÖ

‚úÖ **After admission, `suggestedBlocks.length > 0`** for any sane goal with:
  - Future deadline (not past, min 3 days away)
  - Non-zero capacity (at least 1 block/day or block/week)
  - Valid goal text

‚úÖ **If blocks cannot be generated, UI shows specific error code + reasons**
  - Example: "NO_BLOCKS_GENERATED: Deadline too soon; max blocks/day too low"

‚úÖ **Deliverables UI remains editable, never required for planning**
  - Auto-generated deliverables can be edited/deleted
  - User edits preserve (don't re-seed over manual entries)

‚úÖ **No LLM calls**
  - All pattern-based, deterministic
  - Zero external dependencies

---

## Future Enhancements (Out of Scope)

- [ ] User feedback on auto-generated quality (üëç/üëé to refine patterns)
- [ ] Customizable templates per goal type
- [ ] Adaptive scaling based on user's historical velocity
- [ ] Constraint auto-tuning based on feasibility feedback

---

## Summary

**What was delivered:**
- Deterministic auto-generation of 3+ deliverables per goal
- Automatic block seeding immediately after admission
- Compound goal detection and rejection
- Enhanced plan error diagnostics
- Minimal UI adjustments (collapsible deliverables section)
- Full test coverage (9 new tests)
- No regressions (278 tests passing)

**Impact:**
- Users never see "empty plan" after admission
- Zero manual entry required for basic planning
- Single-outcome goals enforced at admission gate
- Plan generation transparently diagnosed if it fails

---

## Testing

```bash
# Run new tests only
npx vitest run src/domain/autoStrategy.test.ts src/domain/autoSeed.admission.test.ts

# Run all tests
npx vitest run

# Expected: 86 test files, 278 tests passing
```

---

## Deployment Notes

- ‚úÖ Backward compatible (existing cycles unaffected)
- ‚úÖ No database migrations needed
- ‚úÖ No breaking API changes
- ‚úÖ Graceful fallback if auto-seed fails (still creates cycle)
- ‚úÖ LocalStorage schema unchanged (metadata stored in cycle)

